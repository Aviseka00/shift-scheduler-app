{% extends "base.html" %}
{% block content %}
<div class="animate-fade-in-up">
  <h2 class="mb-1" style="font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Manage Shifts</h2>
  <p class="text-muted mb-4">Filter, edit, delete, and reassign shifts and tasks</p>

  <!-- Filters -->
  <div class="glass-card p-4 mb-4">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Filter by Date</label>
        <input type="date" name="date" value="{{ selected_date or '' }}" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Filter by Project</label>
        <select name="project_id" class="form-select">
          <option value="">All Projects</option>
          {% for p in projects %}
          <option value="{{ p._id }}" {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
            {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-2"></i>Filter</button>
        <a href="{{ url_for('manager.manage_shifts') }}" class="btn btn-outline-secondary"><i class="fas fa-times me-2"></i>Clear</a>
      </div>
    </form>
  </div>

  <!-- Add Shift Form -->
  <div class="mb-4">
    <div class="glass-card p-4" style="max-width: 800px; margin: 0 auto;">
      <h4 class="mb-3" style="font-weight: 600; color: #667eea;">
        <i class="fas fa-calendar-plus me-2"></i>Add Shift (Project-wise)
      </h4>
      <form method="post">
        <input type="hidden" name="action" value="add_shift">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Project *</label>
            <select name="project_id" class="form-select" required>
              <option value="">Select Project</option>
              {% for p in projects %}
              <option value="{{ p._id }}" {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
                {{ p.name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Team Member *</label>
            <select name="user_id" id="memberSelect" class="form-select" required>
              <option value="">Select Member</option>
              {% for u in users %}
                {% if u.role == 'member' %}
                <option value="{{ u._id }}">{{ u.name }}</option>
                {% endif %}
              {% endfor %}
            </select>
            {% if selected_project %}
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="showAllMembers" 
                     {% if show_all_members %}checked{% endif %}
                     onchange="toggleMemberFilter()">
              <label class="form-check-label" for="showAllMembers" style="font-size: 0.875rem;">
                Show all members from other projects
              </label>
            </div>
            {% endif %}
          </div>
          <script>
            function toggleMemberFilter() {
              const showAll = document.getElementById('showAllMembers').checked;
              const url = new URL(window.location.href);
              if (showAll) {
                url.searchParams.set('show_all', 'true');
              } else {
                url.searchParams.delete('show_all');
              }
              window.location.href = url.toString();
            }
            
            // Update member list when project changes
            document.querySelector('select[name="project_id"]').addEventListener('change', function() {
              if (this.value) {
                window.location.href = window.location.pathname + '?project_id=' + this.value;
              } else {
                window.location.href = window.location.pathname;
              }
            });
          </script>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Date *</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Shift Code *</label>
            <select name="shift_code" class="form-select" required>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="G">G</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">Start Time</label>
            <input type="time" name="start_time" class="form-control" value="09:00">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">End Time</label>
            <input type="time" name="end_time" class="form-control" value="17:00">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Task Description</label>
          <input type="text" name="task" class="form-control" placeholder="Enter task description">
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-plus me-2"></i>Add Shift
        </button>
      </form>
    </div>
  </div>

  <!-- Tasks List (if filtered by project) -->
  {% if selected_project and tasks %}
  <div class="glass-card p-0 overflow-hidden mb-4">
    <div class="p-3 bg-light border-bottom">
      <h5 class="mb-0" style="font-weight: 600; color: #667eea;">
        <i class="fas fa-tasks me-2"></i>Project Tasks
      </h5>
    </div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>Task Name</th>
            <th>Assigned To</th>
            <th>Due Date</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
          <tr>
            <td><strong>{{ t.task_name }}</strong></td>
            <td>{{ users_map[t.assigned_to|string] }}</td>
            <td>{{ t.due_date or '-' }}</td>
            <td>{{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Shifts List -->
  {% if shifts %}
  <div class="glass-card p-0 overflow-hidden">
    <div class="p-3 bg-light border-bottom">
      <h5 class="mb-0" style="font-weight: 600; color: #667eea;">
        <i class="fas fa-calendar-alt me-2"></i>Shifts
      </h5>
    </div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Project</th>
            <th>Shift Code</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Task</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in shifts %}
          <tr>
            <td><strong>{{ s.date }}</strong></td>
            <td>{{ users_map[s.user_id|string] }}</td>
            <td>
              {% if s.project_id %}
                <span class="badge bg-info">{{ projects_map.get(s.project_id|string, 'Unknown') }}</span>
              {% else %}
                <span class="badge bg-secondary">General</span>
              {% endif %}
            </td>
            <td>
              <span class="badge shift-badge-{{ s.shift_code }}">{{ s.shift_code }}</span>
            </td>
            <td>{{ s.start_time or '09:00' }}</td>
            <td>{{ s.end_time or '17:00' }}</td>
            <td>
              <span class="text-muted">{{ s.task or '-' }}</span>
            </td>
            <td>
              <div class="d-flex gap-1">
                <a href="{{ url_for('manager.edit_shift', shift_id=s._id) }}" class="btn btn-sm btn-outline-primary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <form method="post" action="{{ url_for('manager.delete_shift', shift_id=s._id) }}" class="d-inline" 
                      onsubmit="return confirm('Are you sure you want to delete this shift? This action cannot be undone.');">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </form>
                <button type="button" class="btn btn-sm btn-outline-warning" title="Reassign" 
                        data-bs-toggle="modal" data-bs-target="#reassignModal{{ s._id|string }}">
                  <i class="fas fa-user-exchange"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% for s in shifts %}
  <div class="modal fade" id="reassignModal{{ s._id|string }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reassign Shift</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post" action="{{ url_for('manager.reassign_shift', shift_id=s._id) }}">
          <div class="modal-body">
            <p><strong>Current Member:</strong> {{ users_map[s.user_id|string] }}</p>
            <p><strong>Date:</strong> {{ s.date }}</p>
            {% if s.project_id %}
            <p><strong>Project:</strong> {{ projects_map.get(s.project_id|string, 'Unknown') }}</p>
            {% endif %}
            <div class="mb-3">
              <label class="form-label fw-semibold">Reassign To</label>
              <select name="new_user_id" class="form-select" required id="reassignSelect{{ s._id|string }}">
                <option value="">Select a member</option>
                {% for u in users %}
                  {% if u.role == 'member' and u._id|string != s.user_id|string %}
                  <option value="{{ u._id }}">{{ u.name }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              {% if s.project_id %}
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="showAllReassign{{ s._id|string }}" 
                       data-shift-id="{{ s._id|string }}">
                <label class="form-check-label" for="showAllReassign{{ s._id|string }}" style="font-size: 0.875rem;">
                  Show all members from other projects
                </label>
              </div>
              {% endif %}
            </div>
            <script type="application/json" id="all-members-data-{{ s._id|string }}">
            {{ all_members_json | tojson }}
            </script>
            <script type="application/json" id="filtered-members-data-{{ s._id|string }}">
            {{ users_json | tojson }}
            </script>
            <script>
              (function() {
                const shiftId = '{{ s._id|string }}';
                const allMembers = JSON.parse(document.getElementById('all-members-data-' + shiftId).textContent);
                const filteredMembers = JSON.parse(document.getElementById('filtered-members-data-' + shiftId).textContent);
                const currentUserId = '{{ s.user_id|string }}';
                
                function toggleReassignFilter() {
                  const checkbox = document.getElementById('showAllReassign' + shiftId);
                  const select = document.getElementById('reassignSelect' + shiftId);
                  if (!select) {
                    return;
                  }
                  const showAll = checkbox ? checkbox.checked : false;
                  const currentValue = select.value;
                  
                  select.innerHTML = '<option value="">Select a member</option>';
                  
                  const membersToShow = showAll ? allMembers : filteredMembers;
                  membersToShow.forEach(function(u) {
                    const userId = String(u._id);
                    if (userId !== currentUserId) {
                      const option = document.createElement('option');
                      option.value = userId;
                      option.textContent = u.name;
                      if (userId === currentValue) {
                        option.selected = true;
                      }
                      select.appendChild(option);
                    }
                  });
                }
                
                const checkbox = document.getElementById('showAllReassign' + shiftId);
                if (checkbox) {
                  checkbox.addEventListener('change', toggleReassignFilter);
                }
              })();
            </script>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-warning">Reassign</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="glass-card p-4 text-center">
    <p class="text-muted mb-0">
      {% if selected_date or selected_project %}
        No shifts found with the selected filters.
      {% else %}
        No shifts found. Create a new shift or filter by date/project.
      {% endif %}
    </p>
  </div>
  {% endif %}

  <!-- Legacy Form (for backward compatibility) -->
  {% if selected_date and not selected_project %}
  <div class="glass-card p-4 mt-4">
    <h4 class="mb-3">Quick Edit by Date ({{ selected_date }})</h4>
    <form method="post">
      <input type="hidden" name="date" value="{{ selected_date }}">
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Project</th>
              <th>Shift Code</th>
              <th>Start</th>
              <th>End</th>
              <th>Task</th>
              <th>Save</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            {% set s = shifts_map.get(u._id|string) %}
            <tr>
              <td>
                {{ u.name }}
                <input type="hidden" name="user_id" value="{{ u._id }}">
              </td>
              <td>
                <select name="project_id" class="form-select">
                  <option value="">General</option>
                  {% for p in projects %}
                  <option value="{{ p._id }}" {% if s and s.project_id and s.project_id|string == p._id|string %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select name="shift_code" class="form-select">
                  <option value="A" {% if s and s.shift_code == 'A' %}selected{% endif %}>A</option>
                  <option value="B" {% if s and s.shift_code == 'B' %}selected{% endif %}>B</option>
                  <option value="C" {% if s and s.shift_code == 'C' %}selected{% endif %}>C</option>
                  <option value="G" {% if s and s.shift_code == 'G' %}selected{% endif %}>G</option>
                </select>
              </td>
              <td>
                <input type="time" name="start_time" class="form-control"
                       value="{{ s.start_time if s else '09:00' }}">
              </td>
              <td>
                <input type="time" name="end_time" class="form-control"
                       value="{{ s.end_time if s else '17:00' }}">
              </td>
              <td>
                <input type="text" name="task" class="form-control"
                       value="{{ s.task if s else '' }}">
              </td>
              <td>
                <button class="btn btn-sm btn-primary">Save</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}
