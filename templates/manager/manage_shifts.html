{% extends "base.html" %}
{% block content %}

<h2 class="mb-1" style="font-weight: 700;">
  Manage Shifts
</h2>
<p class="text-muted mb-4">
  Create and edit project-wise shifts. Shift times are auto-set for A / B / C / G.
</p>

<!-- FILTERS -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Filter by Date</label>
        <input type="date" name="date"
               value="{{ selected_date or '' }}" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Filter by Project</label>
        <select name="project_id" class="form-select">
          <option value="">All Projects</option>
          {% for p in projects %}
          <option value="{{ p._id }}"
            {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
            {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter me-1"></i> Filter
        </button>
        <a href="/manager/manage-shifts"
           class="btn btn-outline-secondary">
          Clear
        </a>
      </div>
    </form>
  </div>
</div>

<!-- BULK SHIFT ASSIGNMENT -->
<div class="card shadow-sm mb-4" style="border: 2px solid #667eea;">
  <div class="card-body">
    <h5 class="mb-3" style="color: #667eea;">
      <i class="fas fa-users me-1"></i> Bulk Shift Assignment (Fast Mode)
    </h5>
    <p class="text-muted small mb-3">
      Select multiple members, choose project/shift/date once, and assign shifts to all selected members at once.
    </p>
    
    <form method="post" id="bulkShiftForm">
      <input type="hidden" name="action" value="bulk_add_shifts">
      
      <!-- Project, Shift, Date Selection -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label fw-bold">Project *</label>
          <select name="bulk_project_id" id="bulkProject" class="form-select" required>
            <option value="">Select Project</option>
            {% for p in projects %}
            <option value="{{ p._id }}"
              {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
              {{ p.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Shift Code *</label>
          <select name="bulk_shift_code" id="bulkShift" class="form-select" required>
            <option value="">Select shift</option>
            <option value="A">A (06:00 – 14:30)</option>
            <option value="B">B (14:00 – 22:30)</option>
            <option value="C">C (22:00 – 06:00 next day)</option>
            <option value="G">G (09:00 – 17:30)</option>
            <option value="W">W (Weekoff - All Day)</option>
            <option value="L">L (Leave - All Day)</option>
          </select>
        </div>
        
        <div class="col-md-4">
          <label class="form-label fw-bold">Date *</label>
          <input type="date" name="bulk_date" id="bulkDate" class="form-control" required min="{{ today_date }}">
        </div>
        
        <div class="col-12">
          <label class="form-label">Task / Notes (Optional)</label>
          <input type="text" name="bulk_task" class="form-control" placeholder="Optional task details for all selected members">
        </div>
      </div>
      
      <!-- Member Selection with Checkboxes -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label fw-bold mb-0">Select Members *</label>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllVisibleMembers()">
              <i class="fas fa-check-square me-1"></i> Select All Visible
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllMembers()">
              <i class="fas fa-square me-1"></i> Deselect All
            </button>
          </div>
        </div>
        
        <!-- Search Filter -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" 
                   id="memberSearchInput" 
                   class="form-control" 
                   placeholder="Search members by name, email, or project..." 
                   autocomplete="off"
                   onkeyup="filterMembers()">
            <button type="button" class="btn btn-outline-secondary" onclick="clearMemberSearch()" title="Clear search">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <small class="text-muted">
            <span id="visibleCount">0</span> member(s) visible
          </small>
        </div>
        
        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllVisibleMembers(this)">
                </th>
                <th>Member Name</th>
                <th>Email</th>
                <th>Projects</th>
              </tr>
            </thead>
            <tbody id="memberTableBody">
              {% for u in users %}
              {% set project_names = [] %}
              {% if u.project_ids %}
                {% for pid in u.project_ids %}
                  {% for p in projects %}
                    {% if p._id == pid %}
                      {% set _ = project_names.append(p.name) %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
              {% set project_names_str = project_names|join(', ') or 'No projects' %}
              <tr class="member-row" 
                  data-name="{{ u.name|lower }}" 
                  data-email="{{ u.email|lower }}" 
                  data-projects="{{ project_names_str|lower }}">
                <td>
                  <input type="checkbox" name="selected_members" value="{{ u._id }}" class="member-checkbox">
                </td>
                <td><strong>{{ u.name }}</strong></td>
                <td><small class="text-muted">{{ u.email }}</small></td>
                <td>
                  <small>
                    {% if project_names %}
                      {{ project_names|join(', ') }}
                    {% else %}
                      <span class="text-muted">No projects</span>
                    {% endif %}
                  </small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div id="noResultsMessage" class="alert alert-info d-none" role="alert">
          <i class="fas fa-info-circle me-2"></i>No members found matching your search.
        </div>
        <small class="text-muted">
          <span id="selectedCount">0</span> member(s) selected
        </small>
      </div>
      
      <button type="submit" class="btn btn-primary btn-lg w-100" id="bulkSubmitBtn">
        <i class="fas fa-plus-circle me-2"></i> Assign Shifts to Selected Members
      </button>
    </form>
  </div>
</div>

<!-- ADD SINGLE SHIFT FORM -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3">
      <i class="fas fa-calendar-plus me-1"></i> Add Single Shift
    </h5>
    <form method="post">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Project *</label>
          <select name="project_id" class="form-select" required>
            <option value="">Select Project</option>
            {% for p in projects %}
            <option value="{{ p._id }}"
              {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
              {{ p.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Team Member *</label>
          <select name="user_id" class="form-select" required>
            <option value="">Select member</option>
            {% for u in users %}
            <option value="{{ u._id }}">{{ u.name }} ({{ u.email }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date *</label>
          <input type="date" name="date" class="form-control" required min="{{ today_date }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Shift Code *</label>
          <select name="shift_code" class="form-select" required>
            <option value="">Select shift</option>
            <option value="A">A (06:00 – 14:30)</option>
            <option value="B">B (14:00 – 22:30)</option>
            <option value="C">C (22:00 – 06:00 next day)</option>
            <option value="G">G (09:00 – 17:30)</option>
            <option value="W">W (Weekoff - All Day)</option>
            <option value="L">L (Leave - All Day)</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Task / Notes</label>
          <input type="text" name="task" class="form-control"
                 placeholder="Optional task details">
        </div>
      </div>

      <button type="submit" class="btn btn-primary mt-3 w-100">
        <i class="fas fa-plus me-1"></i> Save Shift
      </button>
    </form>
  </div>
</div>

<!-- SHIFTS TABLE -->
<div class="card shadow-sm">
  <div class="card-header bg-light">
    <strong>Shifts</strong>
  </div>
  <div class="card-body p-0">
    {% if shifts %}
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Project</th>
            <th>Shift</th>
            <th>Start</th>
            <th>End</th>
            <th>Task</th>
            <th style="width: 140px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% set current_shift = "" %}
          {% for s in shifts %}
            {% if current_shift != s.shift_code %}
              {% set current_shift = s.shift_code %}
              <tr class="table-group-header" style="background: 
                {% if s.shift_code == 'A' %}rgba(13, 110, 253, 0.15)
                {% elif s.shift_code == 'G' %}rgba(111, 66, 193, 0.15)
                {% elif s.shift_code == 'B' %}rgba(25, 135, 84, 0.15)
                {% elif s.shift_code == 'C' %}rgba(255, 193, 7, 0.15)
                {% else %}rgba(0, 0, 0, 0.05){% endif %}; border-top: 2px solid 
                {% if s.shift_code == 'A' %}#0d6efd
                {% elif s.shift_code == 'G' %}#6f42c1
                {% elif s.shift_code == 'B' %}#198754
                {% elif s.shift_code == 'C' %}#ffc107
                {% else %}#6c757d{% endif %};">
                <td colspan="8" class="fw-bold py-2">
                  <i class="fas fa-clock me-2"></i>
                  Shift {{ s.shift_code }} 
                  {% if s.shift_code == 'A' %}(06:00 - 14:30)
                  {% elif s.shift_code == 'G' %}(09:00 - 17:30)
                  {% elif s.shift_code == 'B' %}(14:00 - 22:30)
                  {% elif s.shift_code == 'C' %}(22:00 - 06:00)
                  {% endif %}
                </td>
              </tr>
            {% endif %}
          <tr>
            <td>{{ s.date }}</td>
            <td>
              {{ users_map[s.user_id|string] or "Unknown" }}
            </td>
            <td>
              {% if s.project_id %}
                {{ projects_map[s.project_id|string] or "General" }}
              {% else %}
                General
              {% endif %}
            </td>
            <td>
              <span class="badge 
                {% if s.shift_code == 'A' %}bg-primary
                {% elif s.shift_code == 'G' %}bg-info text-dark
                {% elif s.shift_code == 'B' %}bg-success
                {% elif s.shift_code == 'C' %}bg-warning text-dark
                {% else %}bg-secondary{% endif %}">
                {{ s.shift_code }}
              </span>
            </td>
            <td>{{ s.start_time }}</td>
            <td>{{ s.end_time }}</td>
            <td>{{ s.task or "-" }}</td>
            <td>
              <a href="/manager/edit-shift/{{ s._id }}"
                 class="btn btn-sm btn-outline-primary">
                Edit
              </a>
              <form method="post"
                    action="/manager/delete-shift/{{ s._id }}"
                    style="display:inline-block;"
                    onsubmit="return confirm('Delete this shift?');">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger">
                  Del
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted p-3 mb-0">
      No shifts found for the current filter.
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* Search input enhancements */
#memberSearchInput {
  transition: all 0.3s ease;
}

#memberSearchInput:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.member-row {
  transition: opacity 0.2s ease;
}

.member-row[style*="display: none"] {
  opacity: 0;
}

/* Highlight matching text (optional enhancement) */
.member-row strong {
  transition: color 0.2s ease;
}
</style>
<script>
// Update selected count
function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('.member-checkbox:checked');
  document.getElementById('selectedCount').textContent = checkboxes.length;
  
  // Enable/disable submit button
  const submitBtn = document.getElementById('bulkSubmitBtn');
  if (checkboxes.length === 0) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> Please select at least one member';
  } else {
    submitBtn.disabled = false;
    submitBtn.innerHTML = `<i class="fas fa-plus-circle me-2"></i> Assign Shifts to ${checkboxes.length} Selected Member(s)`;
  }
}

// Filter members based on search input
function filterMembers() {
  const searchInput = document.getElementById('memberSearchInput');
  const searchTerm = searchInput.value.toLowerCase().trim();
  const rows = document.querySelectorAll('.member-row');
  const noResultsMessage = document.getElementById('noResultsMessage');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const name = row.getAttribute('data-name') || '';
    const email = row.getAttribute('data-email') || '';
    const projects = row.getAttribute('data-projects') || '';
    
    if (searchTerm === '' || 
        name.includes(searchTerm) || 
        email.includes(searchTerm) || 
        projects.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  // Update visible count
  document.getElementById('visibleCount').textContent = visibleCount;
  
  // Show/hide no results message
  if (visibleCount === 0 && searchTerm !== '') {
    noResultsMessage.classList.remove('d-none');
  } else {
    noResultsMessage.classList.add('d-none');
  }
  
  // Update select all checkbox state based on visible rows
  updateSelectAllCheckboxState();
}

// Clear member search
function clearMemberSearch() {
  document.getElementById('memberSearchInput').value = '';
  filterMembers();
  document.getElementById('memberSearchInput').focus();
}

// Select all visible members
function selectAllVisibleMembers() {
  document.querySelectorAll('.member-row:not([style*="display: none"]) .member-checkbox').forEach(cb => {
    cb.checked = true;
  });
  updateSelectAllCheckboxState();
  updateSelectedCount();
}

// Deselect all members
function deselectAllMembers() {
  document.querySelectorAll('.member-checkbox').forEach(cb => {
    cb.checked = false;
  });
  document.getElementById('selectAllCheckbox').checked = false;
  updateSelectedCount();
}

// Toggle all visible members from header checkbox
function toggleAllVisibleMembers(checkbox) {
  document.querySelectorAll('.member-row:not([style*="display: none"]) .member-checkbox').forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateSelectedCount();
}

// Update select all checkbox state based on visible checked members
function updateSelectAllCheckboxState() {
  const visibleCheckboxes = document.querySelectorAll('.member-row:not([style*="display: none"]) .member-checkbox');
  const visibleChecked = document.querySelectorAll('.member-row:not([style*="display: none"]) .member-checkbox:checked');
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  
  if (visibleCheckboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  } else if (visibleChecked.length === visibleCheckboxes.length) {
    selectAllCheckbox.checked = true;
    selectAllCheckbox.indeterminate = false;
  } else if (visibleChecked.length > 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = true;
  } else {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }
}

// Individual checkbox change
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to all member checkboxes
  document.querySelectorAll('.member-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      updateSelectedCount();
      updateSelectAllCheckboxState();
    });
  });
  
  // Add search input event listener for real-time filtering
  const searchInput = document.getElementById('memberSearchInput');
  if (searchInput) {
    searchInput.addEventListener('input', filterMembers);
    // Allow Enter key to focus on search
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        filterMembers();
      }
    });
  }
  
  // Form validation
  document.getElementById('bulkShiftForm').addEventListener('submit', function(e) {
    const selected = document.querySelectorAll('.member-checkbox:checked').length;
    if (selected === 0) {
      e.preventDefault();
      alert('Please select at least one member to assign shifts.');
      return false;
    }
    
    // Show confirmation
    if (!confirm(`Assign shifts to ${selected} member(s)?`)) {
      e.preventDefault();
      return false;
    }
  });
  
  // Initial count update
  updateSelectedCount();
  filterMembers(); // Initialize visible count
});
</script>
{% endblock %}

