{% extends "base.html" %}
{% block content %}

<h3 class="mb-3" style="font-weight: 700;">
  Team Row-wise View (Project-wise)
</h3>
<p class="text-muted">
  Each row represents a team member. Scroll inside the row to see their weekly shifts.
</p>

<!-- PROJECT FILTER -->
<div class="card shadow-sm mb-4" style="max-width: 600px;">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-12">
        <label class="form-label fw-semibold">Filter by Project</label>
        <select name="project_id" class="form-select" onchange="this.form.submit()">
          <option value="">All Projects</option>
          {% for p in projects %}
          <option value="{{ p._id }}"
            {% if selected_project and selected_project == p._id %}selected{% endif %}>
            {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>
</div>

<!-- TEAM ROW CALENDARS -->
<div class="row g-3">
  {% for u in users %}
  <div class="col-12">
    <div class="card mb-2">
      <div class="card-body">
        <h6 class="mb-2">{{ u.name }} ({{ u.email }})</h6>
        <div id="cal-{{ u._id }}" class="mini-cal"></div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% endblock %}

{% block scripts %}
<script type="application/json" id="users-data">
  {{ users | tojson }}
</script>
<script type="application/json" id="selected-project">
  {{ selected_project | tojson if selected_project else 'null' }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const usersData = JSON.parse(document.getElementById('users-data').textContent);
  const selectedProject = JSON.parse(document.getElementById('selected-project').textContent);
  const apiUrl = "/manager/api/shifts";

  usersData.forEach(function(user) {
    const userId = String(user._id);
    const el = document.getElementById("cal-" + userId);
    if (!el) return;

    const calendar = new FullCalendar.Calendar(el, {
      initialView: "timeGridWeek",
      height: 220,
      slotMinTime: "06:00:00",
      slotMaxTime: "23:00:00",
      headerToolbar: { left: "", center: "", right: "" },
      events: function(fetchInfo, successCallback, failureCallback) {
        const params = new URLSearchParams();
        params.append("user_id", userId);

        if (selectedProject) {
          params.append("project_id", selectedProject);
        }

        fetch(apiUrl + "?" + params.toString())
          .then(response => response.json())
          .then(events => successCallback(events))
          .catch(error => failureCallback(error));
      },
      eventDidMount: function(info) {
        if (info.event.extendedProps.tooltip) {
          info.el.title = info.event.extendedProps.tooltip;
        }
        // Add profile picture to event
        const profilePic = info.event.extendedProps?.profile_pic || 'default.png';
        const profilePicUrl = `/static/uploads/profile_pics/${profilePic}`;
        const img = document.createElement('img');
        img.src = profilePicUrl;
        img.style.width = '18px';
        img.style.height = '18px';
        img.style.borderRadius = '50%';
        img.style.objectFit = 'cover';
        img.style.marginRight = '4px';
        img.style.verticalAlign = 'middle';
        img.onerror = function() {
          this.src = '/static/uploads/profile_pics/default.png';
        };
        if (info.el.querySelector('.fc-event-title')) {
          info.el.querySelector('.fc-event-title').insertBefore(img, info.el.querySelector('.fc-event-title').firstChild);
        } else {
          info.el.insertBefore(img, info.el.firstChild);
        }
      }
    });

    calendar.render();
  });
});
</script>

<style>
.mini-cal {
  border: 1px solid #e5e5e5;
  border-radius: 6px;
  overflow: hidden;
}
</style>
{% endblock %}
