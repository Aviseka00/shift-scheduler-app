{% extends "base.html" %}
{% block content %}

<h2 class="mb-1" style="font-weight: 700;">
  Manage Shifts
</h2>
<p class="text-muted mb-4">
  Create and edit project-wise shifts. Shift times are auto-set for A / B / C / G.
</p>

<!-- FILTERS -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Filter by Date</label>
        <input type="date" name="date"
               value="{{ selected_date or '' }}" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Filter by Project</label>
        <select name="project_id" class="form-select">
          <option value="">All Projects</option>
          {% for p in projects %}
          <option value="{{ p._id }}"
            {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
            {{ p.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter me-1"></i> Filter
        </button>
        <a href="/manager/manage-shifts"
           class="btn btn-outline-secondary">
          Clear
        </a>
      </div>
    </form>
  </div>
</div>

<!-- ADD SHIFT FORM -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="mb-3">
      <i class="fas fa-calendar-plus me-1"></i> Add Shift
    </h5>
    <form method="post">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Project *</label>
          <select name="project_id" class="form-select" required>
            <option value="">Select Project</option>
            {% for p in projects %}
            <option value="{{ p._id }}"
              {% if selected_project and selected_project|string == p._id|string %}selected{% endif %}>
              {{ p.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Team Member *</label>
          <select name="user_id" class="form-select" required>
            <option value="">Select member</option>
            {% for u in users %}
            <option value="{{ u._id }}">{{ u.name }} ({{ u.email }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date *</label>
          <input type="date" name="date" class="form-control" required min="{{ today_date }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Shift Code *</label>
          <select name="shift_code" class="form-select" required>
            <option value="">Select shift</option>
            <option value="A">A (06:00 – 14:30)</option>
            <option value="B">B (14:00 – 22:30)</option>
            <option value="C">C (22:00 – 06:00 next day)</option>
            <option value="G">G (09:00 – 17:30)</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Task / Notes</label>
          <input type="text" name="task" class="form-control"
                 placeholder="Optional task details">
        </div>
      </div>

      <button type="submit" class="btn btn-primary mt-3 w-100">
        <i class="fas fa-plus me-1"></i> Save Shift
      </button>
    </form>
  </div>
</div>

<!-- SHIFTS TABLE -->
<div class="card shadow-sm">
  <div class="card-header bg-light">
    <strong>Shifts</strong>
  </div>
  <div class="card-body p-0">
    {% if shifts %}
    <div class="table-responsive">
      <table class="table mb-0">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Member</th>
            <th>Project</th>
            <th>Shift</th>
            <th>Start</th>
            <th>End</th>
            <th>Task</th>
            <th style="width: 140px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in shifts %}
          <tr>
            <td>{{ s.date }}</td>
            <td>
              {% set member_name = "-" %}
              {% for u in users %}
                {% if u._id == s.user_id %}
                  {% set member_name = u.name %}
                {% endif %}
              {% endfor %}
              {{ member_name }}
            </td>
            <td>
              {% set proj_name = "General" %}
              {% if s.project_id %}
                {% for p in projects %}
                  {% if p._id == s.project_id %}
                    {% set proj_name = p.name %}
                  {% endif %}
                {% endfor %}
              {% endif %}
              {{ proj_name }}
            </td>
            <td><span class="badge bg-primary">{{ s.shift_code }}</span></td>
            <td>{{ s.start_time }}</td>
            <td>{{ s.end_time }}</td>
            <td>{{ s.task or "-" }}</td>
            <td>
              <a href="/manager/edit-shift/{{ s._id }}"
                 class="btn btn-sm btn-outline-primary">
                Edit
              </a>
              <form method="post"
                    action="/manager/delete-shift/{{ s._id }}"
                    style="display:inline-block;"
                    onsubmit="return confirm('Delete this shift?');">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger">
                  Del
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted p-3 mb-0">
      No shifts found for the current filter.
    </p>
    {% endif %}
  </div>
</div>

{% endblock %}
