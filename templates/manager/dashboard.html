{% extends "base.html" %}

{% block content %}
<div class="animate-fade-in-up">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1"
          style="
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;">
        Manager Dashboard
      </h2>
      <p class="text-muted mb-0">Overview of your shift management system</p>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-3 animate-fade-in-up" style="animation-delay: 0.1s;">
      <div class="stat-card stat-card-primary">
        <h6>Total Users</h6>
        <h3>{{ users_count }}</h3>
      </div>
    </div>

    <div class="col-md-3 animate-fade-in-up" style="animation-delay: 0.2s;">
      <div class="stat-card stat-card-success">
        <h6>Total Shifts</h6>
        <h3>{{ shifts_count }}</h3>
      </div>
    </div>

    <div class="col-md-3 animate-fade-in-up" style="animation-delay: 0.3s;">
      <div class="stat-card stat-card-info">
        <h6>Total Projects</h6>
        <h3>{{ project_count }}</h3>
      </div>
    </div>

    <div class="col-md-3 animate-fade-in-up" style="animation-delay: 0.4s;">
      <div class="stat-card stat-card-warning">
        <h6>Pending Requests</h6>
        <h3>{{ pending_change + pending_swap }}</h3>
      </div>
    </div>
  </div>
</div>

<div class="glass-card p-4 mb-4 animate-fade-in-up" style="animation-delay:0.5s;">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-1 fw-bold" style="color:#eae4ff;">Team Schedule</h4>
      <p class="text-muted small mb-0">Visualize and manage all team shifts</p>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="/manager/upload-excel" class="btn btn-sm btn-success">üì§ Upload Shifts</a>
      <a href="/manager/export/csv" class="btn btn-sm btn-outline-success">üìä Export CSV</a>
      <a href="/manager/export/print" target="_blank" class="btn btn-sm btn-outline-secondary">üñ®Ô∏è Print PDF</a>
      <a href="/project/create" class="btn btn-sm btn-primary">‚ûï New Project</a>
    </div>
  </div>

  <form class="row g-3 mb-4" method="post" action="/manager/auto-roster">
    <div class="col-md-3 col-6">
      <label class="form-label fw-semibold">Start Date</label>
      <input type="date" name="start_date" required class="form-control">
    </div>

    <div class="col-md-3 col-6">
      <label class="form-label fw-semibold">End Date</label>
      <input type="date" name="end_date" required class="form-control">
    </div>

    <div class="col-md-3 col-6">
      <label class="form-label fw-semibold">Project</label>
      <select name="project_id" class="form-select">
        <option value="">General</option>
        {% for p in projects %}
          <option value="{{ p._id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3 col-6 d-flex align-items-end">
      <button class="btn btn-primary w-100">‚ú® Auto-generate Roster</button>
    </div>
  </form>

  <div class="shift-legend mb-4">
    <div class="shift-legend-item">
      <span class="shift-legend-color shift-A"></span> <small>Shift A</small>
    </div>
    <div class="shift-legend-item">
      <span class="shift-legend-color shift-B"></span> <small>Shift B</small>
    </div>
    <div class="shift-legend-item">
      <span class="shift-legend-color shift-C"></span> <small>Shift C</small>
    </div>
    <div class="shift-legend-item">
      <span class="shift-legend-color shift-G"></span> <small>Shift G</small>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Filter by Project</label>
      <select id="projectFilter" class="form-select">
        <option value="">All Projects</option>
        {% for p in projects %}
          <option value="{{ p._id }}">{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<div id="managerCalendar" class="glass-card p-4 animate-fade-in-up"
     style="min-height:650px; animation-delay:0.7s;"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const calendarEl = document.getElementById("managerCalendar");
  const projectFilter = document.getElementById("projectFilter");

  const SHIFT_COLORS = {
    A: "#4c6aff",
    B: "#2dd67b",
    C: "#ffe14c",
    G: "#b54cff"
  };

  function buildCalendar(initialView) {
    return new FullCalendar.Calendar(calendarEl, {
      initialView: initialView,
      height: "auto",
      slotMinTime: "06:00:00",
      slotMaxTime: "23:00:00",
      expandRows: true,
      nowIndicator: true,
      editable: true,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },

      events: function(fetchInfo, success, fail) {
        const params = new URLSearchParams();
        if (projectFilter.value) params.append("project_id", projectFilter.value);

        fetch("/manager/api/shifts?" + params)
          .then(r => r.json())
          .then(data => success(data))
          .catch(err => fail(err));
      },

      eventDidMount: function(info) {
        const s = info.event.extendedProps.shift_code;
        info.el.style.backgroundColor = SHIFT_COLORS[s] || "#999";
        info.el.style.borderColor = "#000";
        info.el.style.color = "#000";
        info.el.style.fontWeight = "600";
        info.el.style.boxShadow = "0 0 8px rgba(255,255,255,0.2)";
      },

      eventClick: function(info) {
        const shiftId = info.event.extendedProps.shift_id;
        if (shiftId) {
          window.location.href = `/manager/edit-shift/${shiftId}`;
        }
      }
    });
  }

  const isMobile = window.innerWidth < 768;
  let calendar = buildCalendar(isMobile ? "dayGridMonth" : "timeGridWeek");
  calendar.render();

  projectFilter.addEventListener("change", () => calendar.refetchEvents());
});
</script>
{% endblock %}
