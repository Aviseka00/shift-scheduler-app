{% extends "base.html" %}
{% block content %}

<div class="animate-fade-in-up">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1" style="font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
        üìä Bulk Shift Import
      </h2>
      <p class="text-muted mb-0">Upload Excel file or copy-paste data to import shifts</p>
    </div>
    <a href="/manager/dashboard" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
  </div>

  <!-- Instructions -->
  <div class="glass-card p-4 mb-4">
    <h5 class="mb-3">üìã Instructions</h5>
    <div class="row">
      <div class="col-md-6">
        <div class="alert alert-info">
          <strong>Excel Format Requirements:</strong>
          <ul class="mb-0 mt-2">
            <li>First row must contain headers</li>
            <li><strong>Required columns:</strong> Date, Member Name (or Name), Shift (A/B/C/G)</li>
            <li><strong>Optional columns:</strong> Project, Task</li>
            <li>Date format: YYYY-MM-DD, DD/MM/YYYY, or MM/DD/YYYY</li>
            <li>Shift codes: A, B, C, or G</li>
            <li>Member names must match existing member names or emails</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-success">
          <strong>Copy-Paste Method:</strong>
          <ul class="mb-0 mt-2">
            <li>Copy data from Excel, Google Sheets, or any spreadsheet</li>
            <li>Paste directly into the text area below</li>
            <li>Supports tab-separated or comma-separated values</li>
            <li>First row should be headers</li>
            <li>Shifts will appear in calendar view immediately after import</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="alert alert-warning">
      <strong>Note:</strong> If a shift already exists for a member on a date, it will be updated. All members will see the updated schedule in their calendar view.
    </div>
  </div>

  <!-- Copy-Paste Section -->
  <div class="glass-card p-4 mb-4">
    <h5 class="mb-3">
      <i class="fas fa-paste me-2"></i>Copy-Paste Import (Fastest Method)
    </h5>
    <form method="post" action="/manager/upload-excel" id="pasteForm">
      <input type="hidden" name="action" value="paste">
      <div class="mb-3">
        <label for="paste_data" class="form-label fw-semibold">
          Paste your data here (from Excel, Google Sheets, etc.)
        </label>
        <textarea 
          class="form-control" 
          id="paste_data" 
          name="paste_data" 
          rows="10" 
          placeholder="Date&#9;Member Name&#9;Project&#9;Shift&#9;Task&#10;2025-01-15&#9;John Doe&#9;Project Alpha&#9;A&#9;System Maintenance&#10;2025-01-15&#9;Jane Smith&#9;Project Beta&#9;B&#9;Code Review"
          required
        ></textarea>
        <small class="form-text text-muted">
          Tip: Copy your entire table (including headers) from Excel/Sheets and paste here. The system will automatically detect the format.
        </small>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-upload me-2"></i>Import from Pasted Data
      </button>
      <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearPasteForm()">
        <i class="fas fa-eraser me-2"></i>Clear
      </button>
    </form>
  </div>

  <!-- Excel Upload Section -->
  <div class="glass-card p-4 mb-4">
    <h5 class="mb-3">
      <i class="fas fa-file-excel me-2"></i>Upload Excel File
    </h5>
    <form method="post" action="/manager/upload-excel" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="action" value="upload">
      <div class="mb-3">
        <label for="excel_file" class="form-label fw-semibold">Select Excel File (.xlsx or .xls)</label>
        <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-upload me-2"></i>Upload and Import
      </button>
    </form>
  </div>

  <!-- Errors Display -->
  {% if errors %}
  <div class="glass-card p-4">
    <h5 class="mb-3 text-danger">
      <i class="fas fa-exclamation-triangle me-2"></i>Import Errors
    </h5>
    <div class="alert alert-danger">
      <ul class="mb-0">
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  <!-- Example Format -->
  <div class="glass-card p-4 mt-4">
    <h5 class="mb-3">üìù Example Format</h5>
    <p class="text-muted mb-3">Your data should look like this:</p>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-dark">
          <tr>
            <th>Date</th>
            <th>Member Name</th>
            <th>Project</th>
            <th>Shift</th>
            <th>Task</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>2025-01-15</td>
            <td>John Doe</td>
            <td>Project Alpha</td>
            <td>A</td>
            <td>System Maintenance</td>
          </tr>
          <tr>
            <td>2025-01-15</td>
            <td>Jane Smith</td>
            <td>Project Beta</td>
            <td>B</td>
            <td>Code Review</td>
          </tr>
          <tr>
            <td>2025-01-16</td>
            <td>John Doe</td>
            <td>Project Alpha</td>
            <td>C</td>
            <td>Night Monitoring</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="mt-3">
      <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyExample()">
        <i class="fas fa-copy me-2"></i>Copy Example Data
      </button>
      <small class="text-muted ms-3">Click to copy example data and paste it above to test</small>
    </div>
  </div>

  <!-- Available Members & Projects -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="glass-card p-4">
        <h5 class="mb-3">üë• Available Members</h5>
        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
          {% if users %}
            {% for user in users %}
            <div class="list-group-item">
              <strong>{{ user.name }}</strong>
              <small class="text-muted d-block">{{ user.email }}</small>
            </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">
              No members found. <a href="/register">Register members</a> first.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="glass-card p-4">
        <h5 class="mb-3">üìÅ Available Projects</h5>
        <div class="list-group" style="max-height: 300px; overflow-y: auto;">
          {% for project in projects %}
          <div class="list-group-item">
            <strong>{{ project.name }}</strong>
            {% if project.description %}
            <small class="text-muted d-block">{{ project.description }}</small>
            {% endif %}
          </div>
          {% endfor %}
          {% if not projects %}
          <div class="list-group-item text-muted">
            No projects created yet. <a href="/project/create">Create a project</a> first.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function clearPasteForm() {
  document.getElementById('paste_data').value = '';
}

function copyExample() {
  const exampleData = `Date\tMember Name\tProject\tShift\tTask
2025-01-15\tJohn Doe\tProject Alpha\tA\tSystem Maintenance
2025-01-15\tJane Smith\tProject Beta\tB\tCode Review
2025-01-16\tJohn Doe\tProject Alpha\tC\tNight Monitoring`;
  
  navigator.clipboard.writeText(exampleData).then(function() {
    alert('Example data copied to clipboard! Paste it in the text area above.');
  }, function() {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = exampleData;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Example data copied to clipboard! Paste it in the text area above.');
  });
}

// Auto-detect and format pasted data
document.getElementById('paste_data').addEventListener('paste', function(e) {
  setTimeout(function() {
    const textarea = e.target;
    let value = textarea.value;
    
    // Normalize line breaks
    value = value.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    
    // If it looks like it has proper structure, keep it
    // Otherwise, try to clean it up
    textarea.value = value;
  }, 10);
});
</script>

{% endblock %}
